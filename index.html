<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader</title>
    <style>
        /* CSS变量 - 统一设计系统 */
        :root {
            --primary-bg: #f8f9fa;
            --primary-text: #2c3e50;
            --secondary-text: #7f8c8d;
            --accent-color: #3498db;
            --accent-light: rgba(52, 152, 219, 0.1);
            --accent-hover: #2980b9;
            --glass-bg: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.6);
            
            /* 统一动画曲线 */
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
            
            /* 统一动画时长 */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --duration-slow: 350ms;
            
            /* 统一圆角 */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-full: 9999px;
            
            /* 性能优化 */
            --backdrop-blur: blur(20px) saturate(180%);
            --scrollbar-width: 8px;
        }

        /* 重置和基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--primary-text);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            will-change: auto;
        }

        /* 玻璃态设计 - 统一圆角 */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: var(--radius-lg);
            transition: all var(--duration-normal) var(--ease-smooth);
            will-change: transform, opacity, box-shadow;
            transform: translateZ(0);
        }

        .glass-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .glass:hover:not(.glass-disabled):not(.settings-panel):not(.chapters-panel) {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        /* 应用主体 */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 20px;
            gap: 20px;
            position: relative;
        }

        /* 阅读区域优化 */
        .reading-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-xl);
        }

        .content-container {
            height: 100%;
            overflow-y: auto;
            padding: 60px clamp(40px, 5vw, 100px);
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .content-container::-webkit-scrollbar {
            width: var(--scrollbar-width);
        }

        .content-container::-webkit-scrollbar-track {
            background: transparent;
            border-radius: var(--radius-full);
        }

        .content-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-full);
            transition: background var(--duration-fast) var(--ease-smooth);
        }

        .content-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .content {
            max-width: min(800px, 90vw);
            margin: 0 auto;
            line-height: 1.6;
            font-size: 16px;
            transition: all var(--duration-normal) var(--ease-smooth);
            will-change: font-size, line-height, letter-spacing;
        }

        /* 段落渐显动画 - 性能优化 */
        .content p {
            margin-bottom: 1em;
            transition: all var(--duration-normal);
            opacity: 0;
            transform: translateY(20px);
            will-change: transform, opacity;
        }

        .content p.fade-in {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.6s var(--ease-smooth), transform 0.6s var(--ease-smooth);
        }

        /* 角部控制容器 */
        .corner-control {
            position: fixed;
            z-index: 100;
            transition: all var(--duration-normal) var(--ease-smooth);
            pointer-events: auto;
            will-change: transform, opacity;
        }

        .corner-control.top-left {
            top: 40px;
            left: 40px;
        }

        .corner-control.top-right {
            top: 40px;
            right: 40px;
        }

        .corner-control.bottom-right {
            bottom: 40px;
            right: 40px;
        }

        /* 角部按钮 - 统一圆角 */
        .corner-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-smooth);
            box-shadow: var(--glass-shadow);
        }

        .corner-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .corner-btn:active {
            transform: scale(0.95);
        }

        .corner-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--primary-text);
            transition: stroke var(--duration-fast);
        }

        /* 翻页按钮组 - 统一圆角 */
        .page-control-group {
            display: flex;
            align-items: center;
            padding: 0;
            border-radius: var(--radius-full);
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            height: 56px;
            width: auto;
            gap: 0;
            will-change: transform;
        }

        /* 翻页按钮 */
        .page-btn {
            padding: 0;
            border: none;
            background: transparent;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all var(--duration-fast) var(--ease-smooth);
            flex-shrink: 0;
            width: 56px;
            height: 56px;
        }

        .page-btn:hover:not(.glass-disabled) {
            background: rgba(52, 152, 219, 0.1);
        }

        .page-btn:active:not(.glass-disabled) {
            transform: scale(0.95);
        }

        .page-btn.glass-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .page-btn svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            transition: stroke var(--duration-fast);
        }

        /* 章节标题容器 */
        .chapter-title-container {
            flex: 1;
            min-width: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            position: relative;
            overflow: hidden;
            border-left: 1px solid rgba(0, 0, 0, 0.05);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chapter-title-wrapper {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
        }

        .chapter-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            transition: transform var(--duration-normal) var(--ease-smooth);
            padding: 0 4px;
            text-align: center;
            will-change: transform;
        }

        /* 标题滚动动画 */
        .chapter-title.scrollable {
            animation: scrollTitle 15s linear infinite;
            animation-play-state: paused;
        }

        .chapter-title.scrollable:hover {
            animation-play-state: running;
        }

        @keyframes scrollTitle {
            0% {
                transform: translateX(100%);
            }
            5% {
                transform: translateX(100%);
            }
            95% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        /* 简化的滚动动画 - 只滚动一次 */
        .chapter-title.scroll-once {
            animation: scrollTitleOnce 8s var(--ease-smooth) forwards;
        }

        @keyframes scrollTitleOnce {
            0% {
                transform: translateX(0);
            }
            10% {
                transform: translateX(0);
            }
            90% {
                transform: translateX(calc(-100% + 200px));
            }
            100% {
                transform: translateX(calc(-100% + 200px));
            }
        }

        /* 智能隐藏效果 */
        .corner-control, .page-control-group {
            opacity: 0.9;
            transition: opacity 0.3s var(--ease-smooth);
        }

        .reading-area:hover .corner-control,
        .reading-area:hover .page-control-group,
        .corner-control:hover,
        .page-control-group:hover {
            opacity: 1;
        }

        /* 设置面板和章节面板 - 统一圆角 */
        .settings-panel, .chapters-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            right: auto;
            width: min(320px, 90vw);
            height: calc(100vh - 40px);
            overflow: hidden;
            z-index: 1000;
            transform: translateX(0) translateZ(0);
            transition: all var(--duration-normal) var(--ease-smooth);
            padding: 20px;
            opacity: 1;
            visibility: visible;
            will-change: transform, opacity;
            transform-origin: left center;
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            border-radius: var(--radius-xl);
        }

        .settings-panel {
            left: auto;
            right: 20px;
            transform-origin: right center;
        }

        .settings-panel.collapsed, .chapters-panel.collapsed {
            transform: translateX(calc(100% + 20px)) scale(0.95);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .chapters-panel.collapsed {
            transform: translateX(calc(-100% - 20px)) scale(0.95);
        }

        /* 面板头部 - 统一圆角 */
        .settings-header, .chapters-header {
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .settings-title, .chapters-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-title::before, .chapters-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent-color);
            border-radius: var(--radius-sm);
        }

        .settings-close, .chapters-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-smooth);
            background: var(--glass-highlight);
        }

        .settings-close:hover, .chapters-close:hover {
            background: var(--accent-light);
        }

        /* 面板内容容器 */
        .settings-content, .chapters-list-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
            margin-bottom: 20px;
            padding-right: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .settings-content::-webkit-scrollbar,
        .chapters-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .settings-content::-webkit-scrollbar-track,
        .chapters-list-container::-webkit-scrollbar-track {
            background: transparent;
            border-radius: var(--radius-full);
        }

        .settings-content::-webkit-scrollbar-thumb,
        .chapters-list-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: var(--radius-full);
            transition: background var(--duration-fast);
        }

        .settings-content::-webkit-scrollbar-thumb:hover,
        .chapters-list-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        /* 章节项 - 统一圆角 */
        .chapter-item {
            padding: 14px 18px;
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-smooth);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            font-weight: 400;
            font-size: 14px;
            color: var(--secondary-text);
            will-change: transform, background-color;
        }

        .chapter-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 0;
            background: var(--accent-color);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            transition: all var(--duration-fast) var(--ease-smooth);
        }

        .chapter-item:hover {
            background: rgba(0, 0, 0, 0.02);
            color: var(--primary-text);
            padding-left: 22px;
        }

        .chapter-item:hover::before {
            height: 16px;
        }

        .chapter-item.active {
            background: var(--accent-light);
            color: var(--accent-color);
            font-weight: 500;
            padding-left: 22px;
            box-shadow: 0 0 0 1px rgba(52, 152, 219, 0.2), var(--glass-shadow);
        }

        .chapter-item.active::before {
            height: 24px;
            background: var(--accent-color);
        }

        .chapters-info {
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 12px;
            color: var(--secondary-text);
            text-align: center;
            flex-shrink: 0;
        }

        /* 设置区域 */
        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all var(--duration-normal);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--primary-text);
            padding-right: 40px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--accent-color);
            border-radius: var(--radius-sm);
            flex-shrink: 0;
        }

        .control-group {
            margin-bottom: 16px;
            transition: all var(--duration-normal);
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--secondary-text);
        }

        .control-value {
            font-size: 14px;
            color: var(--accent-color);
            font-weight: 600;
            transition: all var(--duration-fast);
        }

        /* 滑块 - 统一圆角 */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: var(--radius-full);
            background: rgba(0, 0, 0, 0.1);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            transition: all var(--duration-fast);
        }

        .slider:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
            border: 3px solid var(--accent-color);
            transition: all var(--duration-fast) var(--ease-smooth);
        }

        .slider::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .slider::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-full);
            background: white;
            cursor: pointer;
            border: 3px solid var(--accent-color);
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
            transition: all var(--duration-fast);
        }

        /* 按钮 - 统一圆角 */
        .btn {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all var(--duration-fast) var(--ease-smooth);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--glass-shadow);
            color: var(--primary-text);
            letter-spacing: -0.2px;
            will-change: transform;
        }

        .btn:hover:not(.glass-disabled) {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .btn:active:not(.glass-disabled) {
            transform: scale(0.98);
        }

        .btn-primary {
            background: rgba(52, 152, 219, 0.15);
            color: var(--accent-color);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.15);
        }

        .btn-primary:hover:not(.glass-disabled) {
            background: rgba(52, 152, 219, 0.25);
            box-shadow: 0 12px 32px rgba(52, 152, 219, 0.2);
        }

        /* 字体上传 */
        .font-upload {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .font-upload-input {
            display: none;
        }

        .font-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            padding: 12px;
            border-radius: var(--radius-md);
            background: rgba(0, 0, 0, 0.03);
            transition: all var(--duration-fast) var(--ease-smooth);
        }

        .font-upload-label:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .font-upload-label:active {
            transform: scale(0.98);
        }

        /* 字体预览区域 */
        .font-preview {
            margin-top: 12px;
            padding: 16px;
            border-radius: var(--radius-md);
            background: rgba(0, 0, 0, 0.02);
            border: 1px dashed rgba(0, 0, 0, 0.1);
            font-size: 14px;
            text-align: center;
            transition: all var(--duration-fast);
        }

        .font-preview-text {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--primary-text);
        }

        .font-preview-name {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
        }

        /* 文件上传区域 - 统一圆角 */
        .file-upload-area {
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            gap: 24px;
            cursor: pointer;
            transition: all var(--duration-normal);
            border-radius: var(--radius-xl);
            background: rgba(255, 255, 255, 0.5);
            margin: 16px;
        }

        .file-upload-area:hover {
            background: rgba(255, 255, 255, 0.7);
        }

        .upload-icon {
            font-size: 64px;
            color: rgba(52, 152, 219, 0.5);
            margin-bottom: 16px;
            transition: all var(--duration-normal) var(--ease-smooth);
        }

        .file-upload-area:hover .upload-icon {
            color: rgba(52, 152, 219, 0.7);
        }

        /* 存储管理按钮 */
        .storage-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .storage-controls .btn {
            flex: 1;
            min-width: calc(50% - 5px);
            font-size: 13px;
            padding: 10px 12px;
        }

        .storage-info {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: var(--radius-md);
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 249, 250, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--duration-normal) var(--ease-smooth);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-animation {
            display: flex;
            gap: 12px;
        }

        .loading-block {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-color), #2ecc71);
            border-radius: var(--radius-md);
            animation: loading-wave 1.5s var(--ease-bounce) infinite;
        }

        .loading-block:nth-child(2) {
            animation-delay: 0.2s;
            background: linear-gradient(135deg, #2ecc71, #e74c3c);
        }

        .loading-block:nth-child(3) {
            animation-delay: 0.4s;
            background: linear-gradient(135deg, #e74c3c, var(--accent-color));
        }

        @keyframes loading-wave {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            25% {
                transform: translateY(-20px) scale(1.1);
            }
            50% {
                transform: translateY(0) scale(0.9);
            }
            75% {
                transform: translateY(10px) scale(1.05);
            }
        }

        /* 提示条 - 统一圆角 */
        .toast {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 18px 32px;
            border-radius: var(--radius-md);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            transition: transform var(--duration-normal) var(--ease-bounce), opacity var(--duration-normal);
            max-width: min(400px, 90vw);
            text-align: center;
            opacity: 0;
            font-weight: 500;
            will-change: transform, opacity;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.info {
            border-left: 4px solid var(--accent-color);
        }

        /* 设置面板展开时的遮罩 */
        .settings-mask, .chapters-mask {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--duration-normal) var(--ease-smooth);
        }

        .settings-mask.active, .chapters-mask.active {
            opacity: 1;
            visibility: visible;
        }

        /* 滚动触发动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s var(--ease-smooth) forwards;
        }

        /* 性能优化：减少重绘 */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- 设置面板遮罩 -->
    <div class="settings-mask" id="settingsMask"></div>
    
    <!-- 章节面板遮罩 -->
    <div class="chapters-mask" id="chaptersMask"></div>

    <!-- 应用容器 -->
    <div class="app-container">
        <!-- 阅读区域 -->
        <div class="reading-area glass">
            <!-- 文件上传区域 -->
            <div class="file-upload-area" id="fileUploadArea">
                <div class="upload-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                </div>
                <h2 style="font-weight: 600; margin-bottom: 8px;">拖放TXT文件到此处或点击选择文件</h2>
                <p style="color: var(--secondary-text); max-width: 400px; line-height: 1.6;">仅支持UTF-8编码的TXT文件</p>
                <input type="file" id="fileInput" accept=".txt" style="display: none;">
                <button class="btn btn-primary" id="selectFileBtn">选择TXT文件</button>
                
                <!-- 历史记录 -->
                <div id="historyList" style="margin-top: 30px; width: 100%; max-width: 400px; display: none;">
                    <h3 style="font-size: 14px; color: var(--secondary-text); margin-bottom: 10px; text-align: left;">最近阅读</h3>
                    <div id="historyItems"></div>
                </div>
            </div>

            <!-- 阅读内容区域 -->
            <div class="content-container" id="contentContainer" style="display: none;">
                <!-- 内容区域 -->
                <div class="content" id="content">
                    <!-- 内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 章节导航按钮 - 左上角 -->
    <div class="corner-control top-left">
        <button class="corner-btn glass" id="chapterNavBtn" title="章节导航">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
        </button>
    </div>
    
    <!-- 设置按钮 - 右上角 -->
    <div class="corner-control top-right">
        <button class="corner-btn glass" id="settingsBtn" title="设置">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
        </button>
    </div>
    
    <!-- 翻页按钮 - 右下角 -->
    <div class="corner-control bottom-right">
        <div class="page-control-group glass" id="pageControlGroup">
            <button class="page-btn" id="prevPageBtn" title="上一章">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </button>
            
            <!-- 章节标题容器 -->
            <div class="chapter-title-container">
                <div class="chapter-title-wrapper">
                    <div class="chapter-title" id="chapterTitle">暂无章节</div>
                </div>
            </div>
            
            <button class="page-btn" id="nextPageBtn" title="下一章">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 设置面板 -->
    <div class="settings-panel glass collapsed" id="settingsPanel">
        <!-- 设置面板头部 -->
        <div class="settings-header">
            <h2 class="settings-title">设置</h2>
            <div class="settings-close" id="settingsClose">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </div>
        </div>
        
        <!-- 设置内容容器 -->
        <div class="settings-content">
            <!-- 文字样式 -->
            <div class="settings-section">
                <h3 class="section-title">文字样式</h3>
                
                <div class="control-group">
                    <label class="control-label">字体大小: <span class="control-value" id="fontSizeValue">16px</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="fontSize" min="12" max="20" value="16" step="1">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">字重: <span class="control-value" id="fontWeightValue">400</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="fontWeight" min="400" max="900" value="400" step="100">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">字间距: <span class="control-value" id="letterSpacingValue">0px</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="letterSpacing" min="0" max="20" value="0" step="1">
                    </div>
                </div>
                
                <button class="btn" id="resetTextStyle">重置文字样式</button>
            </div>
            
            <!-- 段落样式 -->
            <div class="settings-section">
                <h3 class="section-title">段落样式</h3>
                
                <div class="control-group">
                    <label class="control-label">行间距: <span class="control-value" id="lineHeightValue">1.6</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="lineHeight" min="10" max="30" value="16" step="1">
                    </div>
                </div>
                
                <div class="control-group">
                    <label class="control-label">段落间距: <span class="control-value" id="paragraphSpacingValue">1.0em</span></label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="paragraphSpacing" min="5" max="30" value="10" step="1">
                    </div>
                </div>
                
                <button class="btn" id="resetParagraphStyle">重置段落样式</button>
            </div>
            
            <!-- 字体设置 -->
            <div class="settings-section">
                <h3 class="section-title">字体设置</h3>
                
                <div class="font-upload">
                    <input type="file" id="fontUpload" accept=".ttf,.otf,.woff,.woff2" class="font-upload-input">
                    <label for="fontUpload" class="font-upload-label">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        上传字体文件 (TTF/OTF/WOFF)
                    </label>
                    
                    <!-- 字体预览区域 -->
                    <div class="font-preview" id="fontPreview" style="display: none;">
                        <div class="font-preview-text" id="fontPreviewText">字体预览：中文字体示例</div>
                        <div class="font-preview-name" id="fontPreviewName"></div>
                    </div>
                    
                    <button class="btn" id="resetFont">恢复默认字体</button>
                </div>
            </div>
            
            <!-- 存储管理 -->
            <div class="settings-section">
                <h3 class="section-title">存储管理</h3>
                <div class="storage-controls">
                    <button class="btn" id="clearNovelData" title="清除所有小说数据">清除小说数据</button>
                    <button class="btn" id="clearSettings" title="清除所有设置">清除设置</button>
                    <button class="btn" id="exportData" title="导出所有数据">导出数据</button>
                    <button class="btn" id="importData" title="导入数据" style="display: none;">导入数据</button>
                </div>
                <div class="storage-info" id="storageInfo">
                    正在计算存储使用情况...
                </div>
            </div>
            
            <!-- 重置所有设置 -->
            <div class="settings-section">
                <button class="btn btn-primary" id="resetAllStyles">重置所有设置</button>
            </div>
        </div>
    </div>

    <!-- 章节面板 -->
    <div class="chapters-panel glass collapsed" id="chaptersPanel">
        <div class="chapters-header">
            <h2 class="chapters-title">章节列表</h2>
            <div class="chapters-close" id="chaptersClose">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </div>
        </div>
        
        <!-- 章节列表容器 -->
        <div class="chapters-list-container">
            <div class="chapters-list" id="chaptersList">
                <!-- 章节列表将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <div class="chapters-info">
            共 <span id="chaptersCount">0</span> 章
        </div>
    </div>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-block"></div>
            <div class="loading-block"></div>
            <div class="loading-block"></div>
        </div>
    </div>

    <!-- 提示条 -->
    <div class="toast" id="toast"></div>

    <script>
        // 性能优化：使用requestAnimationFrame进行动画
        const raf = window.requestAnimationFrame || 
                    window.webkitRequestAnimationFrame || 
                    window.mozRequestAnimationFrame || 
                    window.msRequestAnimationFrame || 
                    function(callback) { return setTimeout(callback, 1000/60); };

        // 全局变量
        const APP = {
            currentNovel: null,
            chapters: [],
            currentChapterIndex: 0,
            scrollPosition: 0,
            fontSize: 16,
            fontWeight: 400,
            letterSpacing: 0,
            lineHeight: 1.6,
            paragraphSpacing: 1.0,
            customFont: null,
            settingsPanelOpen: false,
            chaptersPanelOpen: false,
            isAnimating: false,
            observer: null,
            db: null,
            indexedDBName: 'NovelReaderDB',
            indexedDBVersion: 2,
            titleAnimationTimeout: null,
            isTitleScrolling: false,
            // 性能优化：防抖计时器
            debounceTimers: new Map()
        };

        // DOM元素引用
        const dom = {
            settingsMask: document.getElementById('settingsMask'),
            chaptersMask: document.getElementById('chaptersMask'),
            contentContainer: document.getElementById('contentContainer'),
            content: document.getElementById('content'),
            fileUploadArea: document.getElementById('fileUploadArea'),
            fileInput: document.getElementById('fileInput'),
            selectFileBtn: document.getElementById('selectFileBtn'),
            chapterNavBtn: document.getElementById('chapterNavBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            pageControlGroup: document.getElementById('pageControlGroup'),
            settingsPanel: document.getElementById('settingsPanel'),
            chaptersPanel: document.getElementById('chaptersPanel'),
            settingsClose: document.getElementById('settingsClose'),
            chaptersClose: document.getElementById('chaptersClose'),
            chaptersList: document.getElementById('chaptersList'),
            chaptersCount: document.getElementById('chaptersCount'),
            fontSize: document.getElementById('fontSize'),
            fontSizeValue: document.getElementById('fontSizeValue'),
            fontWeight: document.getElementById('fontWeight'),
            fontWeightValue: document.getElementById('fontWeightValue'),
            letterSpacing: document.getElementById('letterSpacing'),
            letterSpacingValue: document.getElementById('letterSpacingValue'),
            lineHeight: document.getElementById('lineHeight'),
            lineHeightValue: document.getElementById('lineHeightValue'),
            paragraphSpacing: document.getElementById('paragraphSpacing'),
            paragraphSpacingValue: document.getElementById('paragraphSpacingValue'),
            resetTextStyle: document.getElementById('resetTextStyle'),
            resetParagraphStyle: document.getElementById('resetParagraphStyle'),
            resetFont: document.getElementById('resetFont'),
            resetAllStyles: document.getElementById('resetAllStyles'),
            fontUpload: document.getElementById('fontUpload'),
            fontPreview: document.getElementById('fontPreview'),
            fontPreviewText: document.getElementById('fontPreviewText'),
            fontPreviewName: document.getElementById('fontPreviewName'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            toast: document.getElementById('toast'),
            clearNovelData: document.getElementById('clearNovelData'),
            clearSettings: document.getElementById('clearSettings'),
            exportData: document.getElementById('exportData'),
            importData: document.getElementById('importData'),
            storageInfo: document.getElementById('storageInfo'),
            historyList: document.getElementById('historyList'),
            historyItems: document.getElementById('historyItems'),
            chapterTitle: document.getElementById('chapterTitle')
        };

        // 防抖函数 - 性能优化
        function debounce(func, wait, key) {
            return function(...args) {
                if (APP.debounceTimers.has(key)) {
                    clearTimeout(APP.debounceTimers.get(key));
                }
                
                const timer = setTimeout(() => {
                    func.apply(this, args);
                    APP.debounceTimers.delete(key);
                }, wait);
                
                APP.debounceTimers.set(key, timer);
            };
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', async () => {
            initEventListeners();
            await initDatabase();
            await loadSettings();
            await loadReadingHistory();
            initIntersectionObserver();
            updateStorageInfo();
            
            // 初始状态
            dom.settingsPanel.classList.add('collapsed');
            dom.chaptersPanel.classList.add('collapsed');
            
            // 初始化字体预览
            updateFontPreview();
        });

        // 初始化事件监听器
        function initEventListeners() {
            // 文件上传相关
            dom.selectFileBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', handleFileSelect);
            
            // 拖放文件支持
            dom.fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dom.fileUploadArea.style.borderColor = 'rgba(52, 152, 219, 0.5)';
                dom.fileUploadArea.style.background = 'rgba(255, 255, 255, 0.8)';
            });
            
            dom.fileUploadArea.addEventListener('dragleave', () => {
                dom.fileUploadArea.style.borderColor = 'rgba(52, 152, 219, 0.2)';
                dom.fileUploadArea.style.background = 'rgba(255, 255, 255, 0.5)';
            });
            
            dom.fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dom.fileUploadArea.style.borderColor = 'rgba(52, 152, 219, 0.2)';
                dom.fileUploadArea.style.background = 'rgba(255, 255, 255, 0.5)';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
            
            // 控制按钮事件
            dom.chapterNavBtn.addEventListener('click', toggleChaptersPanel);
            dom.settingsBtn.addEventListener('click', toggleSettingsPanel);
            dom.prevPageBtn.addEventListener('click', prevChapter);
            dom.nextPageBtn.addEventListener('click', nextChapter);
            
            // 关闭面板按钮
            dom.settingsClose.addEventListener('click', toggleSettingsPanel);
            dom.chaptersClose.addEventListener('click', toggleChaptersPanel);
            
            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevChapter();
                if (e.key === 'ArrowRight') nextChapter();
                if (e.key === 'Escape') {
                    if (APP.settingsPanelOpen) toggleSettingsPanel();
                    if (APP.chaptersPanelOpen) toggleChaptersPanel();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                    e.preventDefault();
                    toggleSettingsPanel();
                }
            });
            
            // 点击遮罩关闭面板
            dom.settingsMask.addEventListener('click', () => {
                if (APP.settingsPanelOpen) {
                    toggleSettingsPanel();
                }
            });
            
            dom.chaptersMask.addEventListener('click', () => {
                if (APP.chaptersPanelOpen) {
                    toggleChaptersPanel();
                }
            });
            
            // 样式控制 - 使用防抖
            dom.fontSize.addEventListener('input', debounce(updateFontSize, 100, 'fontSize'));
            dom.fontWeight.addEventListener('input', debounce(updateFontWeight, 100, 'fontWeight'));
            dom.letterSpacing.addEventListener('input', debounce(updateLetterSpacing, 100, 'letterSpacing'));
            dom.lineHeight.addEventListener('input', debounce(updateLineHeight, 100, 'lineHeight'));
            dom.paragraphSpacing.addEventListener('input', debounce(updateParagraphSpacing, 100, 'paragraphSpacing'));
            
            // 重置按钮
            dom.resetTextStyle.addEventListener('click', resetTextStyle);
            dom.resetParagraphStyle.addEventListener('click', resetParagraphStyle);
            dom.resetFont.addEventListener('click', resetFontStyle);
            dom.resetAllStyles.addEventListener('click', resetAllStyles);
            
            // 字体上传
            dom.fontUpload.addEventListener('change', handleFontUpload);
            
            // 内容区域滚动保存 - 使用防抖
            dom.contentContainer.addEventListener('scroll', debounce(saveScrollPosition, 500, 'scroll'));
            
            // 存储管理
            dom.clearNovelData.addEventListener('click', clearNovelData);
            dom.clearSettings.addEventListener('click', clearSettings);
            dom.exportData.addEventListener('click', exportAllData);
            
            // 导入功能通过隐藏的文件输入实现
            const importInput = document.createElement('input');
            importInput.type = 'file';
            importInput.accept = '.json';
            importInput.style.display = 'none';
            document.body.appendChild(importInput);
            
            dom.importData.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', handleDataImport);
            
            // 章节标题悬停事件
            dom.chapterTitle.addEventListener('mouseenter', () => {
                if (dom.chapterTitle.classList.contains('scrollable')) {
                    dom.chapterTitle.style.animationPlayState = 'paused';
                }
            });
            
            dom.chapterTitle.addEventListener('mouseleave', () => {
                if (dom.chapterTitle.classList.contains('scrollable')) {
                    dom.chapterTitle.style.animationPlayState = 'running';
                }
            });
            
            // 性能优化：监听页面可见性变化
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveProgress();
                }
            });
            
            // 页面卸载前保存数据
            window.addEventListener('beforeunload', () => {
                saveProgress();
            });
        }

        // 初始化IndexedDB数据库
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(APP.indexedDBName, APP.indexedDBVersion);
                
                request.onerror = (event) => {
                    console.error('IndexedDB打开失败:', event.target.error);
                    showToast('本地存储初始化失败，部分功能可能不可用', 'error');
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    APP.db = event.target.result;
                    console.log('IndexedDB打开成功');
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('novels')) {
                        const novelsStore = db.createObjectStore('novels', { keyPath: 'id' });
                        novelsStore.createIndex('name', 'name', { unique: false });
                        novelsStore.createIndex('lastRead', 'lastRead', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('progress')) {
                        const progressStore = db.createObjectStore('progress', { keyPath: 'novelId' });
                        progressStore.createIndex('lastRead', 'lastRead', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('fonts')) {
                        db.createObjectStore('fonts', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    console.log('IndexedDB结构创建/更新完成');
                };
            });
        }

        // 混合存储方案
        class StorageManager {
            // 判断数据大小，选择存储方案
            static shouldUseIndexedDB(data) {
                const dataSize = JSON.stringify(data).length;
                return dataSize > 1024 * 1024; // > 1MB 使用 IndexedDB
            }
            
            // 保存小说数据
            static async saveNovel(novel) {
                try {
                    const contentSize = JSON.stringify(novel.chapters).length;
                    
                    if (contentSize > 1024 * 1024) {
                        return await this.saveToIndexedDB('novels', novel);
                    } else {
                        return this.saveToLocalStorage(`novel_${novel.id}`, novel);
                    }
                } catch (error) {
                    console.error('保存小说失败:', error);
                    throw error;
                }
            }
            
            // 保存阅读进度
            static async saveProgress(novelId, chapterIndex, scrollTop) {
                const progress = {
                    novelId: novelId,
                    chapterIndex: chapterIndex,
                    scrollPosition: scrollTop,
                    lastRead: new Date().toISOString()
                };
                
                try {
                    return this.saveToLocalStorage(`progress_${novelId}`, progress);
                } catch (error) {
                    console.error('保存进度失败:', error);
                    throw error;
                }
            }
            
            // 保存设置
            static async saveSettings(settings) {
                try {
                    return this.saveToLocalStorage('settings', settings);
                } catch (error) {
                    console.error('保存设置失败:', error);
                    throw error;
                }
            }
            
            // 保存字体
            static async saveFont(font) {
                try {
                    return await this.saveToIndexedDB('fonts', font);
                } catch (error) {
                    console.error('保存字体失败:', error);
                    throw error;
                }
            }
            
            // 加载小说数据
            static async loadNovel(novelId) {
                try {
                    const novel = this.loadFromLocalStorage(`novel_${novelId}`);
                    if (novel) return novel;
                    
                    return await this.loadFromIndexedDB('novels', novelId);
                } catch (error) {
                    console.error('加载小说失败:', error);
                    return null;
                }
            }
            
            // 加载所有小说信息（仅元数据）
            static async loadAllNovels() {
                try {
                    const novels = [];
                    
                    // 从 LocalStorage 加载
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('novel_')) {
                            const novel = JSON.parse(localStorage.getItem(key));
                            if (novel && novel.name) {
                                novels.push({
                                    id: novel.id,
                                    name: novel.name,
                                    size: novel.size,
                                    lastModified: novel.lastModified,
                                    chaptersCount: novel.chapters ? novel.chapters.length : 0,
                                    storageType: 'localStorage'
                                });
                            }
                        }
                    }
                    
                    // 从 IndexedDB 加载
                    if (APP.db) {
                        const transaction = APP.db.transaction(['novels'], 'readonly');
                        const store = transaction.objectStore('novels');
                        const request = store.getAll();
                        
                        await new Promise((resolve) => {
                            request.onsuccess = () => {
                                request.result.forEach(novel => {
                                    novels.push({
                                        id: novel.id,
                                        name: novel.name,
                                        size: novel.size,
                                        lastModified: novel.lastModified,
                                        chaptersCount: novel.chapters ? novel.chapters.length : 0,
                                        storageType: 'indexedDB'
                                    });
                                });
                                resolve();
                            };
                        });
                    }
                    
                    // 按最后阅读时间排序
                    novels.sort((a, b) => {
                        const progressA = this.loadFromLocalStorage(`progress_${a.id}`);
                        const progressB = this.loadFromLocalStorage(`progress_${b.id}`);
                        const timeA = progressA ? new Date(progressA.lastRead) : new Date(0);
                        const timeB = progressB ? new Date(progressB.lastRead) : new Date(0);
                        return timeB - timeA;
                    });
                    
                    return novels;
                } catch (error) {
                    console.error('加载所有小说失败:', error);
                    return [];
                }
            }
            
            // 加载阅读进度
            static loadProgress(novelId) {
                return this.loadFromLocalStorage(`progress_${novelId}`);
            }
            
            // 加载设置
            static loadSettings() {
                return this.loadFromLocalStorage('settings') || {};
            }
            
            // 加载字体
            static async loadFont(fontId = 'userFont') {
                try {
                    return await this.loadFromIndexedDB('fonts', fontId);
                } catch (error) {
                    console.error('加载字体失败:', error);
                    return null;
                }
            }
            
            // 删除小说数据
            static async deleteNovel(novelId) {
                try {
                    localStorage.removeItem(`novel_${novelId}`);
                    localStorage.removeItem(`progress_${novelId}`);
                    
                    if (APP.db) {
                        const transaction = APP.db.transaction(['novels', 'progress'], 'readwrite');
                        transaction.objectStore('novels').delete(novelId);
                        transaction.objectStore('progress').delete(novelId);
                        await new Promise(resolve => transaction.oncomplete = resolve);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('删除小说失败:', error);
                    throw error;
                }
            }
            
            // 删除所有小说数据
            static async deleteAllNovels() {
                try {
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key.startsWith('novel_') || key.startsWith('progress_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    if (APP.db) {
                        const transaction = APP.db.transaction(['novels', 'progress'], 'readwrite');
                        transaction.objectStore('novels').clear();
                        transaction.objectStore('progress').clear();
                        await new Promise(resolve => transaction.oncomplete = resolve);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('删除所有小说失败:', error);
                    throw error;
                }
            }
            
            // 删除所有设置
            static deleteAllSettings() {
                try {
                    localStorage.removeItem('settings');
                    
                    if (APP.db) {
                        const transaction = APP.db.transaction(['settings'], 'readwrite');
                        transaction.objectStore('settings').clear();
                    }
                    
                    this.deleteFont();
                    
                    return true;
                } catch (error) {
                    console.error('删除所有设置失败:', error);
                    throw error;
                }
            }
            
            // 删除字体
            static async deleteFont() {
                try {
                    if (APP.db) {
                        const transaction = APP.db.transaction(['fonts'], 'readwrite');
                        transaction.objectStore('fonts').clear();
                        await new Promise(resolve => transaction.oncomplete = resolve);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('删除字体失败:', error);
                    throw error;
                }
            }
            
            // 获取存储使用情况
            static async getStorageInfo() {
                try {
                    let totalSize = 0;
                    let itemsCount = 0;
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        totalSize += key.length + value.length;
                        itemsCount++;
                    }
                    
                    if (APP.db && 'estimate' in APP.db) {
                        const estimate = await APP.db.estimate();
                        totalSize += estimate.usage;
                    }
                    
                    return {
                        totalSize: totalSize,
                        itemsCount: itemsCount,
                        formattedSize: this.formatBytes(totalSize)
                    };
                } catch (error) {
                    console.error('获取存储信息失败:', error);
                    return { totalSize: 0, itemsCount: 0, formattedSize: '0 B' };
                }
            }
            
            // 导出所有数据
            static async exportAllData() {
                try {
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        novels: [],
                        settings: {},
                        fonts: []
                    };
                    
                    // 导出 LocalStorage 中的小说
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('novel_')) {
                            const novel = JSON.parse(localStorage.getItem(key));
                            if (novel) {
                                exportData.novels.push({
                                    id: novel.id,
                                    name: novel.name,
                                    chapters: novel.chapters,
                                    size: novel.size,
                                    lastModified: novel.lastModified,
                                    storageType: 'localStorage'
                                });
                            }
                        }
                    }
                    
                    // 导出 IndexedDB 中的小说
                    if (APP.db) {
                        const transaction = APP.db.transaction(['novels'], 'readonly');
                        const store = transaction.objectStore('novels');
                        const request = store.getAll();
                        
                        await new Promise((resolve) => {
                            request.onsuccess = () => {
                                request.result.forEach(novel => {
                                    exportData.novels.push({
                                        id: novel.id,
                                        name: novel.name,
                                        chapters: novel.chapters,
                                        size: novel.size,
                                        lastModified: novel.lastModified,
                                        storageType: 'indexedDB'
                                    });
                                });
                                resolve();
                            };
                        });
                    }
                    
                    // 导出设置
                    exportData.settings = this.loadSettings();
                    
                    // 导出字体
                    const font = await this.loadFont();
                    if (font) {
                        exportData.fonts.push(font);
                    }
                    
                    return exportData;
                } catch (error) {
                    console.error('导出数据失败:', error);
                    throw error;
                }
            }
            
            // 导入数据
            static async importData(data) {
                try {
                    if (!data.version || data.version !== '1.0') {
                        throw new Error('不支持的导出文件格式');
                    }
                    
                    let importedCount = 0;
                    
                    // 导入小说
                    if (data.novels && Array.isArray(data.novels)) {
                        for (const novel of data.novels) {
                            try {
                                await this.saveNovel(novel);
                                importedCount++;
                            } catch (error) {
                                console.warn(`导入小说失败 ${novel.name}:`, error);
                            }
                        }
                    }
                    
                    // 导入设置
                    if (data.settings) {
                        await this.saveSettings(data.settings);
                    }
                    
                    // 导入字体
                    if (data.fonts && Array.isArray(data.fonts) && data.fonts.length > 0) {
                        for (const font of data.fonts) {
                            try {
                                await this.saveFont(font);
                            } catch (error) {
                                console.warn('导入字体失败:', error);
                            }
                        }
                    }
                    
                    return importedCount;
                } catch (error) {
                    console.error('导入数据失败:', error);
                    throw error;
                }
            }
            
            // 辅助方法：保存到 LocalStorage
            static saveToLocalStorage(key, data) {
                try {
                    const dataStr = JSON.stringify(data);
                    localStorage.setItem(key, dataStr);
                    return true;
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        throw new Error('本地存储空间不足，请清除一些数据或使用较小的文件');
                    }
                    throw error;
                }
            }
            
            // 辅助方法：从 LocalStorage 加载
            static loadFromLocalStorage(key) {
                try {
                    const dataStr = localStorage.getItem(key);
                    return dataStr ? JSON.parse(dataStr) : null;
                } catch (error) {
                    console.error(`从LocalStorage加载${key}失败:`, error);
                    return null;
                }
            }
            
            // 辅助方法：保存到 IndexedDB
            static saveToIndexedDB(storeName, data) {
                return new Promise((resolve, reject) => {
                    if (!APP.db) {
                        reject(new Error('IndexedDB未初始化'));
                        return;
                    }
                    
                    const transaction = APP.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = (event) => {
                        console.error(`保存到IndexedDB失败:`, event.target.error);
                        reject(event.target.error);
                    };
                });
            }
            
            // 辅助方法：从 IndexedDB 加载
            static loadFromIndexedDB(storeName, key) {
                return new Promise((resolve, reject) => {
                    if (!APP.db) {
                        resolve(null);
                        return;
                    }
                    
                    const transaction = APP.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result || null);
                    request.onerror = (event) => {
                        console.error(`从IndexedDB加载失败:`, event.target.error);
                        reject(event.target.error);
                    };
                });
            }
            
            // 辅助方法：格式化字节大小
            static formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 B';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
        }

        // 加载设置
        async function loadSettings() {
            try {
                const settings = await StorageManager.loadSettings();
                
                if (settings) {
                    APP.fontSize = settings.fontSize || 16;
                    APP.fontWeight = settings.fontWeight || 400;
                    APP.letterSpacing = settings.letterSpacing || 0;
                    APP.lineHeight = settings.lineHeight || 1.6;
                    APP.paragraphSpacing = settings.paragraphSpacing || 1.0;
                    
                    // 更新UI控件
                    dom.fontSize.value = APP.fontSize;
                    dom.fontSizeValue.textContent = `${APP.fontSize}px`;
                    dom.fontWeight.value = APP.fontWeight;
                    dom.fontWeightValue.textContent = APP.fontWeight;
                    dom.letterSpacing.value = APP.letterSpacing;
                    dom.letterSpacingValue.textContent = `${APP.letterSpacing}px`;
                    dom.lineHeight.value = Math.round(APP.lineHeight * 10);
                    dom.lineHeightValue.textContent = APP.lineHeight.toFixed(1);
                    dom.paragraphSpacing.value = Math.round(APP.paragraphSpacing * 10);
                    dom.paragraphSpacingValue.textContent = `${APP.paragraphSpacing.toFixed(1)}em`;
                    
                    // 应用样式
                    applyTextStyles();
                }
                
                // 加载自定义字体
                const font = await StorageManager.loadFont();
                if (font) {
                    APP.customFont = font;
                    applyCustomFont();
                }
            } catch (error) {
                console.error('加载设置失败:', error);
                showToast('加载设置失败', 'error');
            }
        }

        // 保存设置
        async function saveSettings() {
            try {
                const settings = {
                    fontSize: APP.fontSize,
                    fontWeight: APP.fontWeight,
                    letterSpacing: APP.letterSpacing,
                    lineHeight: APP.lineHeight,
                    paragraphSpacing: APP.paragraphSpacing
                };
                
                await StorageManager.saveSettings(settings);
            } catch (error) {
                console.error('保存设置失败:', error);
                showToast('保存设置失败', 'error');
            }
        }

        // 保存阅读进度
        async function saveProgress() {
            if (!APP.currentNovel || APP.chapters.length === 0) return;
            
            try {
                await StorageManager.saveProgress(
                    APP.currentNovel.id,
                    APP.currentChapterIndex,
                    APP.scrollPosition
                );
            } catch (error) {
                console.error('保存进度失败:', error);
            }
        }

        // 保存小说数据
        async function saveNovel() {
            if (!APP.currentNovel || APP.chapters.length === 0) return;
            
            try {
                const novel = {
                    id: APP.currentNovel.id,
                    name: APP.currentNovel.name,
                    chapters: APP.chapters,
                    size: APP.currentNovel.size,
                    lastModified: APP.currentNovel.lastModified
                };
                
                await StorageManager.saveNovel(novel);
                
                // 更新阅读历史
                await loadReadingHistory();
            } catch (error) {
                console.error('保存小说失败:', error);
                showToast('保存小说失败: ' + error.message, 'error');
            }
        }

        // 加载阅读历史
        async function loadReadingHistory() {
            try {
                const novels = await StorageManager.loadAllNovels();
                
                if (novels.length > 0) {
                    dom.historyList.style.display = 'block';
                    dom.historyItems.innerHTML = '';
                    
                    novels.slice(0, 5).forEach(novel => {
                        const progress = StorageManager.loadProgress(novel.id);
                        
                        const item = document.createElement('div');
                        item.className = 'chapter-item glass';
                        item.style.marginBottom = '8px';
                        item.style.cursor = 'pointer';
                        item.innerHTML = `
                            <div style="font-weight: 500; margin-bottom: 4px;">${novel.name}</div>
                            <div style="font-size: 12px; color: var(--secondary-text);">
                                共${novel.chaptersCount}章 | 
                                ${progress ? `上次阅读: 第${progress.chapterIndex + 1}章` : '未开始阅读'}
                            </div>
                        `;
                        
                        item.addEventListener('click', async () => {
                            await loadNovelFromStorage(novel.id);
                        });
                        
                        dom.historyItems.appendChild(item);
                    });
                } else {
                    dom.historyList.style.display = 'none';
                }
            } catch (error) {
                console.error('加载阅读历史失败:', error);
            }
        }

        // 从存储加载小说
        async function loadNovelFromStorage(novelId) {
            showLoading(true);
            
            try {
                const novel = await StorageManager.loadNovel(novelId);
                
                if (!novel) {
                    throw new Error('小说数据不存在');
                }
                
                APP.currentNovel = {
                    id: novel.id,
                    name: novel.name,
                    size: novel.size,
                    lastModified: novel.lastModified
                };
                
                APP.chapters = novel.chapters || [];
                
                // 加载阅读进度
                const progress = StorageManager.loadProgress(novelId);
                
                if (progress) {
                    APP.currentChapterIndex = progress.chapterIndex || 0;
                    APP.scrollPosition = progress.scrollPosition || 0;
                } else {
                    APP.currentChapterIndex = 0;
                    APP.scrollPosition = 0;
                }
                
                // 更新UI
                updateChaptersList();
                renderChapter();
                showContentArea();
                
                showToast(`《${novel.name}》加载成功`, 'success');
                
            } catch (error) {
                console.error('加载小说失败:', error);
                showToast('加载小说失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 读取文件内容
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    resolve(event.target.result);
                };
                
                reader.onerror = () => {
                    reject(new Error('文件读取失败'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // 处理文件选择
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.txt')) {
                showToast('请选择TXT格式的文件', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const novelId = await generateFileHash(file);
                APP.currentNovel = {
                    id: novelId,
                    name: file.name,
                    size: file.size,
                    lastModified: file.lastModified
                };
                
                const content = await readFileContent(file);
                
                if (!content || content.trim().length === 0) {
                    throw new Error('文件内容为空');
                }
                
                APP.chapters = parseChapters(content);
                
                if (APP.chapters.length === 0) {
                    throw new Error('无法解析章节结构，请检查文件格式');
                }
                
                await saveNovel();
                
                const progress = StorageManager.loadProgress(novelId);
                
                if (progress) {
                    APP.currentChapterIndex = progress.chapterIndex || 0;
                    APP.scrollPosition = progress.scrollPosition || 0;
                } else {
                    APP.currentChapterIndex = 0;
                    APP.scrollPosition = 0;
                }
                
                updateChaptersList();
                renderChapter();
                showContentArea();
                
                showToast(`《${file.name}》加载成功，共${APP.chapters.length}章`, 'success');
                
            } catch (error) {
                console.error('文件加载失败:', error);
                showToast('文件加载失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
                dom.fileInput.value = '';
            }
        }

        // 生成文件哈希作为唯一标识
        async function generateFileHash(file) {
            return `${file.name}_${file.size}_${file.lastModified}`.replace(/\s+/g, '_');
        }

        // 解析章节
        function parseChapters(content) {
            const chapters = [];
            
            const chapterRegex = /^(第[零一二三四五六七八九十百千万\d]+章|第[零一二三四五六七八九十百千万\d]+回|第[零一二三四五六七八九十百千万\d]+节|第[零一二三四五六七八九十百千万\d]+卷|第[零一二三四五六七八九十百千万\d]+篇|[上下]?卷之[零一二三四五六七八九十百千万\d]+|CHAPTER\s+\d+|Chapter\s+\d+|\d+\.\s+|【.*?】|\[.*?\])/im;
            
            const lines = content.split(/\r?\n/);
            let currentChapter = { title: '开始', content: '' };
            let inChapter = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === '') continue;
                
                if (chapterRegex.test(line)) {
                    if (inChapter) {
                        chapters.push({ ...currentChapter });
                    } else {
                        inChapter = true;
                    }
                    
                    currentChapter = {
                        title: line,
                        content: ''
                    };
                } else if (inChapter) {
                    if (currentChapter.content) {
                        currentChapter.content += '\n' + line;
                    } else {
                        currentChapter.content = line;
                    }
                } else {
                    if (currentChapter.content) {
                        currentChapter.content += '\n' + line;
                    } else {
                        currentChapter.content = line;
                    }
                }
            }
            
            if (currentChapter.content) {
                chapters.push({ ...currentChapter });
            }
            
            if (chapters.length === 0) {
                chapters.push({
                    title: '全文',
                    content: content
                });
            }
            
            return chapters;
        }

        // 更新章节列表
        function updateChaptersList() {
            dom.chaptersList.innerHTML = '';
            dom.chaptersCount.textContent = APP.chapters.length;
            
            APP.chapters.forEach((chapter, index) => {
                const item = document.createElement('div');
                item.className = `chapter-item glass ${index === APP.currentChapterIndex ? 'active' : ''}`;
                item.textContent = chapter.title;
                item.title = chapter.title;
                
                item.addEventListener('click', () => {
                    APP.currentChapterIndex = index;
                    APP.scrollPosition = 0;
                    renderChapter();
                    updateChaptersList();
                    saveProgress();
                    toggleChaptersPanel();
                });
                
                dom.chaptersList.appendChild(item);
            });
        }

        // 渲染当前章节
        function renderChapter() {
            if (APP.chapters.length === 0) return;
            
            const chapter = APP.chapters[APP.currentChapterIndex];
            let contentHTML = '';
            
            const paragraphs = chapter.content.split(/\n+/);
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    contentHTML += `<p>${paragraph}</p>`;
                }
            });
            
            dom.content.innerHTML = contentHTML;
            
            updateChapterTitle(chapter.title);
            
            applyTextStyles();
            
            updateNavButtons();
            
            // 使用requestAnimationFrame优化动画
            raf(() => {
                const paragraphs = dom.content.querySelectorAll('p');
                paragraphs.forEach(p => {
                    p.classList.remove('fade-in');
                    if (APP.observer) {
                        APP.observer.observe(p);
                    }
                });
            });
            
            if (APP.scrollPosition > 0) {
                setTimeout(() => {
                    dom.contentContainer.scrollTop = APP.scrollPosition;
                }, 50);
            }
            
            updateChaptersList();
        }

        // 更新章节标题显示
        function updateChapterTitle(title) {
            dom.chapterTitle.textContent = title || '无标题';
            
            dom.chapterTitle.classList.remove('scrollable', 'scroll-once');
            
            if (APP.titleAnimationTimeout) {
                clearTimeout(APP.titleAnimationTimeout);
                APP.titleAnimationTimeout = null;
            }
            
            dom.chapterTitle.style.transform = 'translateX(0)';
            dom.chapterTitle.style.animation = '';
            
            setTimeout(() => {
                const containerWidth = dom.chapterTitle.parentElement.offsetWidth;
                const titleWidth = dom.chapterTitle.scrollWidth;
                
                if (titleWidth > containerWidth) {
                    APP.titleAnimationTimeout = setTimeout(() => {
                        dom.chapterTitle.classList.add('scroll-once');
                        
                        APP.titleAnimationTimeout = setTimeout(() => {
                            dom.chapterTitle.classList.remove('scroll-once');
                            dom.chapterTitle.style.transform = 'translateX(0)';
                        }, 8000);
                    }, 2000);
                }
            }, 100);
        }

        // 显示内容区域
        function showContentArea() {
            dom.fileUploadArea.style.display = 'none';
            dom.contentContainer.style.display = 'block';
        }

        // 更新翻页按钮状态
        function updateNavButtons() {
            const hasPrev = APP.currentChapterIndex > 0;
            const hasNext = APP.currentChapterIndex < APP.chapters.length - 1;
            
            [dom.prevPageBtn].forEach(btn => {
                if (hasPrev) {
                    btn.classList.remove('glass-disabled');
                } else {
                    btn.classList.add('glass-disabled');
                }
            });
            
            [dom.nextPageBtn].forEach(btn => {
                if (hasNext) {
                    btn.classList.remove('glass-disabled');
                } else {
                    btn.classList.add('glass-disabled');
                }
            });
        }

        // 上一章
        function prevChapter() {
            if (APP.currentChapterIndex > 0) {
                APP.currentChapterIndex--;
                APP.scrollPosition = 0;
                renderChapter();
                saveProgress();
                dom.contentContainer.scrollTop = 0;
            }
        }

        // 下一章
        function nextChapter() {
            if (APP.currentChapterIndex < APP.chapters.length - 1) {
                APP.currentChapterIndex++;
                APP.scrollPosition = 0;
                renderChapter();
                saveProgress();
                dom.contentContainer.scrollTop = 0;
            }
        }

        // 保存滚动位置
        function saveScrollPosition() {
            if (APP.currentNovel && APP.chapters.length > 0) {
                APP.scrollPosition = dom.contentContainer.scrollTop;
                saveProgress();
            }
        }

        // 应用文本样式
        function applyTextStyles() {
            dom.content.style.fontSize = `${APP.fontSize}px`;
            dom.content.style.fontWeight = APP.fontWeight;
            dom.content.style.letterSpacing = `${APP.letterSpacing}px`;
            dom.content.style.lineHeight = APP.lineHeight;
            
            const paragraphs = dom.content.querySelectorAll('p');
            paragraphs.forEach(p => {
                p.style.marginBottom = `${APP.paragraphSpacing}em`;
            });
        }

        // 更新字体大小
        function updateFontSize() {
            APP.fontSize = parseInt(dom.fontSize.value);
            dom.fontSizeValue.textContent = `${APP.fontSize}px`;
            applyTextStyles();
            saveSettings();
        }

        // 更新字体粗细
        function updateFontWeight() {
            APP.fontWeight = parseInt(dom.fontWeight.value);
            dom.fontWeightValue.textContent = APP.fontWeight;
            applyTextStyles();
            saveSettings();
        }

        // 更新字间距
        function updateLetterSpacing() {
            APP.letterSpacing = parseInt(dom.letterSpacing.value);
            dom.letterSpacingValue.textContent = `${APP.letterSpacing}px`;
            applyTextStyles();
            saveSettings();
        }

        // 更新行间距
        function updateLineHeight() {
            APP.lineHeight = parseInt(dom.lineHeight.value) / 10;
            dom.lineHeightValue.textContent = APP.lineHeight.toFixed(1);
            applyTextStyles();
            saveSettings();
        }

        // 更新段落间距
        function updateParagraphSpacing() {
            APP.paragraphSpacing = parseInt(dom.paragraphSpacing.value) / 10;
            dom.paragraphSpacingValue.textContent = `${APP.paragraphSpacing.toFixed(1)}em`;
            applyTextStyles();
            saveSettings();
        }

        // 重置文字样式
        async function resetTextStyle() {
            APP.fontSize = 16;
            APP.fontWeight = 400;
            APP.letterSpacing = 0;
            
            dom.fontSize.value = APP.fontSize;
            dom.fontSizeValue.textContent = `${APP.fontSize}px`;
            dom.fontWeight.value = APP.fontWeight;
            dom.fontWeightValue.textContent = APP.fontWeight;
            dom.letterSpacing.value = APP.letterSpacing;
            dom.letterSpacingValue.textContent = `${APP.letterSpacing}px`;
            
            applyTextStyles();
            await saveSettings();
            showToast('文字样式已重置', 'success');
        }

        // 重置段落样式
        async function resetParagraphStyle() {
            APP.lineHeight = 1.6;
            APP.paragraphSpacing = 1.0;
            
            dom.lineHeight.value = Math.round(APP.lineHeight * 10);
            dom.lineHeightValue.textContent = APP.lineHeight.toFixed(1);
            dom.paragraphSpacing.value = Math.round(APP.paragraphSpacing * 10);
            dom.paragraphSpacingValue.textContent = `${APP.paragraphSpacing.toFixed(1)}em`;
            
            applyTextStyles();
            await saveSettings();
            showToast('段落样式已重置', 'success');
        }

        // 重置字体
        async function resetFontStyle() {
            APP.customFont = null;
            
            try {
                await StorageManager.deleteFont();
                document.body.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif";
                updateFontPreview();
                showToast('字体已恢复为默认', 'success');
            } catch (error) {
                console.error('重置字体失败:', error);
                showToast('重置字体失败', 'error');
            }
        }

        // 重置所有设置
        async function resetAllStyles() {
            await resetTextStyle();
            await resetParagraphStyle();
            await resetFontStyle();
            showToast('所有设置已重置', 'success');
        }

        // 处理字体上传
        async function handleFontUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validExtensions = ['.ttf', '.otf', '.woff', '.woff2'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!validExtensions.includes(fileExtension)) {
                showToast('请选择TTF、OTF、WOFF或WOFF2格式的字体文件', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const reader = new FileReader();
                
                const fontData = await new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('字体文件读取失败'));
                    };
                    
                    reader.readAsArrayBuffer(file);
                });
                
                const base64Font = arrayBufferToBase64(fontData);
                
                let fontFormat;
                switch (fileExtension) {
                    case '.ttf':
                        fontFormat = 'truetype';
                        break;
                    case '.otf':
                        fontFormat = 'opentype';
                        break;
                    case '.woff':
                        fontFormat = 'woff';
                        break;
                    case '.woff2':
                        fontFormat = 'woff2';
                        break;
                    default:
                        fontFormat = 'truetype';
                }
                
                const font = {
                    id: 'userFont',
                    name: file.name.replace(fileExtension, ''),
                    data: base64Font,
                    format: fontFormat,
                    fileType: fileExtension.substring(1).toUpperCase(),
                    uploadedAt: new Date().toISOString(),
                    size: file.size
                };
                
                APP.customFont = font;
                await StorageManager.saveFont(font);
                
                applyCustomFont();
                updateFontPreview();
                
                showToast(`字体"${font.name}"上传成功`, 'success');
            } catch (error) {
                console.error('字体上传失败:', error);
                showToast('字体上传失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 将ArrayBuffer转换为Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // 应用自定义字体
        function applyCustomFont() {
            if (!APP.customFont) return;
            
            try {
                const existingStyles = document.querySelectorAll('[data-custom-font-style]');
                existingStyles.forEach(style => style.remove());
                
                const fontFamilyName = 'CustomFont_' + Date.now();
                
                const style = document.createElement('style');
                style.setAttribute('data-custom-font-style', 'true');
                
                const fontData = APP.customFont.data;
                const fontFormat = APP.customFont.format;
                
                const fontFaceRule = `
                @font-face {
                    font-family: '${fontFamilyName}';
                    src: url('data:font/${APP.customFont.fileType.toLowerCase()};charset=utf-8;base64,${fontData}') format('${fontFormat}');
                    font-weight: normal;
                    font-style: normal;
                    font-display: swap;
                }
                `;
                
                style.textContent = fontFaceRule;
                document.head.appendChild(style);
                
                const testElement = document.createElement('span');
                testElement.style.fontFamily = fontFamilyName;
                testElement.style.position = 'absolute';
                testElement.style.left = '-9999px';
                testElement.style.fontSize = '16px';
                testElement.textContent = '测试字体加载';
                document.body.appendChild(testElement);
                
                setTimeout(() => {
                    const loaded = document.fonts.check(`16px ${fontFamilyName}`);
                    
                    if (loaded) {
                        document.body.style.fontFamily = `'${fontFamilyName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif`;
                        console.log(`字体加载成功: ${fontFamilyName}`);
                        showToast(`字体"${APP.customFont.name}"加载成功`, 'success');
                    } else {
                        console.warn('字体加载失败，尝试备用方法');
                        applyCustomFontFallback(fontFamilyName, fontData, fontFormat);
                    }
                    
                    document.body.removeChild(testElement);
                    updateFontPreview();
                    
                }, 100);
                
            } catch (error) {
                console.error('应用自定义字体失败:', error);
                showToast('应用自定义字体失败: ' + error.message, 'error');
            }
        }

        // 备用方法：使用FontFace API
        function applyCustomFontFallback(fontFamilyName, fontData, fontFormat) {
            try {
                const existingFonts = document.fonts.values();
                for (const font of existingFonts) {
                    if (font.family.startsWith('CustomFont_')) {
                        document.fonts.delete(font);
                    }
                }
                
                const binary = atob(fontData);
                const array = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    array[i] = binary.charCodeAt(i);
                }
                
                const blob = new Blob([array], { type: `font/${APP.customFont.fileType.toLowerCase()}` });
                const fontUrl = URL.createObjectURL(blob);
                
                const fontFace = new FontFace(fontFamilyName, `url(${fontUrl}) format('${fontFormat}')`, {
                    style: 'normal',
                    weight: '400',
                    display: 'swap'
                });
                
                fontFace.load().then((loadedFace) => {
                    document.fonts.add(loadedFace);
                    document.body.style.fontFamily = `'${fontFamilyName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif`;
                    
                    setTimeout(() => URL.revokeObjectURL(fontUrl), 1000);
                    
                    console.log(`字体通过备用方法加载成功: ${fontFamilyName}`);
                    showToast(`字体"${APP.customFont.name}"加载成功`, 'success');
                    
                }).catch((error) => {
                    console.error('备用方法字体加载失败:', error);
                    showToast('自定义字体加载失败，可能是字体文件损坏或不支持', 'error');
                });
                
            } catch (error) {
                console.error('备用方法失败:', error);
                showToast('字体加载失败: ' + error.message, 'error');
            }
        }

        // 更新字体预览
        function updateFontPreview() {
            if (APP.customFont) {
                dom.fontPreview.style.display = 'block';
                dom.fontPreviewText.textContent = `字体预览：${APP.customFont.name}`;
                dom.fontPreviewName.textContent = `当前字体: ${APP.customFont.name} (${APP.customFont.fileType})`;
                dom.fontPreviewText.style.fontFamily = document.body.style.fontFamily;
            } else {
                dom.fontPreview.style.display = 'none';
                dom.fontPreviewText.textContent = '字体预览：中文字体示例';
                dom.fontPreviewName.textContent = '';
                dom.fontPreviewText.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif";
            }
        }

        // 清除小说数据
        async function clearNovelData() {
            if (!confirm('确定要清除所有小说数据吗？此操作不可恢复。')) {
                return;
            }
            
            showLoading(true);
            
            try {
                await StorageManager.deleteAllNovels();
                
                APP.currentNovel = null;
                APP.chapters = [];
                APP.currentChapterIndex = 0;
                APP.scrollPosition = 0;
                
                dom.fileUploadArea.style.display = 'flex';
                dom.contentContainer.style.display = 'none';
                dom.chaptersList.innerHTML = '';
                dom.chaptersCount.textContent = '0';
                dom.chapterTitle.textContent = '请选择章节';
                
                await loadReadingHistory();
                
                showToast('所有小说数据已清除', 'success');
            } catch (error) {
                console.error('清除小说数据失败:', error);
                showToast('清除小说数据失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
                updateStorageInfo();
            }
        }

        // 清除设置
        async function clearSettings() {
            if (!confirm('确定要清除所有设置吗？此操作不可恢复。')) {
                return;
            }
            
            showLoading(true);
            
            try {
                await StorageManager.deleteAllSettings();
                await loadSettings();
                showToast('所有设置已清除', 'success');
            } catch (error) {
                console.error('清除设置失败:', error);
                showToast('清除设置失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
                updateStorageInfo();
            }
        }

        // 导出所有数据
        async function exportAllData() {
            showLoading(true);
            
            try {
                const exportData = await StorageManager.exportAllData();
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `novel-reader-backup-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                
                showToast('数据导出成功', 'success');
            } catch (error) {
                console.error('导出数据失败:', error);
                showToast('导出数据失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 处理数据导入
        async function handleDataImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.json')) {
                showToast('请选择JSON格式的备份文件', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const reader = new FileReader();
                
                const importData = await new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        try {
                            resolve(JSON.parse(e.target.result));
                        } catch (error) {
                            reject(new Error('文件格式错误'));
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('文件读取失败'));
                    };
                    
                    reader.readAsText(file);
                });
                
                const importedCount = await StorageManager.importData(importData);
                
                await loadSettings();
                await loadReadingHistory();
                
                updateFontPreview();
                
                showToast(`数据导入成功，共导入${importedCount}本小说`, 'success');
            } catch (error) {
                console.error('导入数据失败:', error);
                showToast('导入数据失败: ' + error.message, 'error');
            } finally {
                showLoading(false);
                event.target.value = '';
                updateStorageInfo();
            }
        }

        // 更新存储信息
        async function updateStorageInfo() {
            try {
                const info = await StorageManager.getStorageInfo();
                dom.storageInfo.textContent = 
                    `已使用: ${info.formattedSize} | 项目数: ${info.itemsCount}`;
            } catch (error) {
                console.error('更新存储信息失败:', error);
                dom.storageInfo.textContent = '无法获取存储信息';
            }
        }

        // 切换章节面板
        function toggleChaptersPanel() {
            if (APP.isAnimating) return;
            
            APP.isAnimating = true;
            APP.chaptersPanelOpen = !APP.chaptersPanelOpen;
            
            if (APP.chaptersPanelOpen) {
                dom.chaptersPanel.classList.remove('collapsed');
                dom.chaptersMask.classList.add('active');
                
                updateChaptersList();
                
                setTimeout(() => {
                    const activeItem = dom.chaptersList.querySelector('.chapter-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
                
            } else {
                dom.chaptersPanel.classList.add('collapsed');
                dom.chaptersMask.classList.remove('active');
            }
            
            setTimeout(() => {
                APP.isAnimating = false;
            }, APP.chaptersPanelOpen ? 500 : 300);
        }

        // 切换设置面板
        function toggleSettingsPanel() {
            if (APP.isAnimating) return;
            
            APP.isAnimating = true;
            APP.settingsPanelOpen = !APP.settingsPanelOpen;
            
            if (APP.settingsPanelOpen) {
                dom.settingsPanel.classList.remove('collapsed');
                dom.settingsMask.classList.add('active');
                
                updateStorageInfo();
                
            } else {
                dom.settingsPanel.classList.add('collapsed');
                dom.settingsMask.classList.remove('active');
            }
            
            setTimeout(() => {
                APP.isAnimating = false;
            }, APP.settingsPanelOpen ? 500 : 300);
        }

        // 初始化Intersection Observer用于段落渐显动画
        function initIntersectionObserver() {
            const options = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
            
            APP.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                        APP.observer.unobserve(entry.target);
                    }
                });
            }, options);
        }

        // 显示加载动画
        function showLoading(show) {
            if (show) {
                dom.loadingOverlay.classList.add('active');
            } else {
                dom.loadingOverlay.classList.remove('active');
            }
        }

        // 显示提示条
        function showToast(message, type = 'info', duration = 3000) {
            dom.toast.textContent = message;
            dom.toast.className = `toast ${type}`;
            dom.toast.classList.add('show');
            
            setTimeout(() => {
                dom.toast.classList.remove('show');
            }, duration);
        }
    </script>
</body>
</html>
